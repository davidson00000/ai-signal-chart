# DOMAIN_RULES_TRADING.md
EXITON 自動投資システム — トレーディング領域ドメインルール v0.1
==============================================================

本ドキュメントは、EXITON 自動投資システム（以下「本システム」）における
**ドメイン固有ルール（業務ルール・投資ロジックに関する前提）** を定義する。

機能実装・テスト・レビュー・将来の商用化検討において、
ここに書かれたルールは **必ず満たされなければならない**。

- ルールID 形式：`DR-TR-XXX`
- 変更時は必ず Git 管理下で差分が追跡可能であること

---

## 1. システムのスコープ・前提

### DR-TR-001 本システムの目的
- 本システムは **売買シグナルの生成・バックテスト・学習支援ツール** であり、  
  現時点では **証券会社への自動発注は一切行わない**。
- 利用者は、本システムの出力を参考情報として扱い、
  最終的な投資判断・売買執行は **利用者自身の責任** で行う。

### DR-TR-002 投資対象
- デフォルト対象は、米国株・日本株・主要インデックス・ETF を想定する。
- 具体的な銘柄範囲は、データソースに依存し、`DATA_SOURCE_SPEC.md` 側で定義する。

### DR-TR-003 自動売買との分離
- 発注ロジックや証券会社 API との連携が追加される場合、  
  本ドキュメントとは別に `DOMAIN_RULES_EXECUTION.md` を新設し、  
  **売買執行ドメイン** と明確に切り離して定義する。

---

## 2. データに関するルール（時系列・OHLCV）

### DR-TR-010 ルックアヘッド禁止
- いかなるバックテスト・シミュレーションにおいても、  
  **その時点で利用可能でなかった未来データ** を参照してはならない。
- 特に以下は禁止：
  - 当日の終値でシグナルを出し、同日の終値で約定させる
  - 翌日のギャップを当日判断に利用する
- 実装レベルで「使用可能なデータ範囲」を明示し、テストで検証すること。

### DR-TR-011 日付・タイムゾーンの一貫性
- すべての時刻は **UTC** を基準として保存する。
- 表示はユーザー設定（例：JST）に変換して行う。
- 日足データは、データ提供元の定義に従い、
  1 本のバーが **[前日クローズ後〜当日クローズまで]** などの意味を持つことを前提に扱う。

### DR-TR-012 データ欠損・スパイク処理
- 欠損データ・異常スパイクが見つかった場合：
  - デフォルトは「その区間のバックテストをスキップ」か「警告を出して中断」する。
  - 補間ロジックを導入する場合は、
    - その手法（前日値補完 / 線形補完 等）を明示
    - バックテスト結果に与える影響を説明できる状態にすること。

---

## 3. 売買ロジック・ポジション管理ルール

### DR-TR-020 売買単位
- 現物株のバックテストにおいては、
  **売買数量は常に売買単位（単位株）に丸める**。
- 丸め規則：
  - デフォルト：`floor(数量)`（切り捨て）
  - 将来的に変更する場合は `DR-TR-020` のバージョンアップとして記録する。

### DR-TR-021 手数料・スリッページ
- バックテスト時には、必ず **手数料・スリッページのモデル** を適用する。
- 最低限、以下のいずれかを適用する：
  - 固定額手数料（例：1トレードあたり$5）
  - 約定代金に比例する手数料（例：0.1%）
  - スリッページ（例：約定価格に ±X% の誤差）
- 手数料モデルを UI から設定可能にする場合、  
  その選択が結果に与える影響をユーザーが認識しやすい形で表示する。

### DR-TR-022 レバレッジ・信用取引
- 初期バージョンでは **レバレッジ 1倍（現物のみ）** を前提とする。
- 信用取引・レバレッジを導入する場合：
  - 証拠金管理ルール
  - 強制ロスカット条件
  - 空売り可否
  を別途 `DR-TR-03X` として定義する。

### DR-TR-023 ポジションサイジング
- ポジションサイズの計算は、原則として **R（1R = 口座資産に対する許容損失量）** の概念で扱う。
- 初期実装では：
  - ユーザーが「1R」を金額または％で設定
  - ストップ位置に応じて株数を決定
- 本ルールの具体式は `DOMAIN_RULES_RISK_MANAGEMENT.md` に詳細化する。

---

## 4. 戦略・シグナルに関するルール

### DR-TR-030 戦略IDとバージョン管理
- 各戦略には一意な ID を付与する：  
  - 例：`STR_MA_001`, `STR_RSI_001`
- 戦略ロジックを変更した場合：
  - バグ修正レベル → パッチバージョンアップ（`v1.0.1` など）
  - アルゴリズム構造変更 → マイナーバージョンアップ（`v1.1` など）
- バックテスト結果には **戦略ID＋バージョン** を必ず紐づける。

### DR-TR-031 シグナルの意味の統一
- 「BUY」「SELL」「HOLD」などのシグナルは、全戦略で意味を統一する：
  - BUY：新規買い、またはショートポジションのクローズ＋ロングオープン
  - SELL：保有ロングポジションのクローズ、または新規ショート（現物のみの場合はクローズ限定）
- 戦略固有の特殊シグナル（例：`REDUCE`, `ADD`) を導入する場合、
  - 意味を `STRATEGY_DOC_<ID>.md` に明記する。

### DR-TR-032 シグナルのタイミング
- シグナルは常に「どの足のどのタイミングの情報で判断されるか」を明確にする。
  - 例：日足終値ベース戦略 → 当日終値確定後にシグナル決定、翌営業日寄りで想定約定。
- UI でも「どのタイミングのシグナルか」を説明できるようにする。

---

## 5. 利用者への説明・リスク表示

### DR-TR-040 投資助言ではない旨の明示
- 本システムは **投資一任・投資助言サービスではない** ことを、
  UI の目立つ位置に明示する。
- 将来的に商用化する場合も、  
  法的な区分に応じた表現を `LEGAL_NOTICE.md` で管理する。

### DR-TR-041 過去成績と将来成績
- バックテスト結果表示時には、
  「過去の成績が将来の成績を保証しない」旨の注意文を常に添える。

---

## 6. 変更管理

### DR-TR-050 ルール変更時の手順
- 本ドキュメントを変更する際は：
  1. Pull Request で変更案を提示
  2. 変更理由・影響範囲を説明
  3. テスト・仕様書の更新を含めてレビュー
- 重大なルール変更（例：レバレッジ導入）時には、
  - バージョンを `v0.1 → v0.2` のように上げる。

---

以上。
