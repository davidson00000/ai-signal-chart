# NFR_TRADING.md
EXITON 自動投資システム — 非機能要件（トレーディング領域） v0.1
================================================================

本ドキュメントは、自動投資システム（バックテスト・シグナル生成）の
**非機能要件（NFR: Non-Functional Requirements）** を定義する。

機能仕様（何ができるか）ではなく、
**どう動くべきか・どのような品質レベルを満たすべきか** を対象とする。

- 要件ID形式：`NFR-TR-XXX`

---

## 1. パフォーマンス要件

### NFR-TR-001 バックテスト応答時間
- 日足ベースの単一銘柄バックテストについて：
  - 期間：最大 10 年
  - データポイント：およそ 2500 営業日
- 上記条件のバックテストは、
  - 通常負荷時に **10秒以内** に完了することを目標とする。
- 初期段階では「目標値」とし、将来的に SLO として厳密化する。

### NFR-TR-002 シグナル生成応答時間
- 「最新データを用いたシグナル再計算」は、
  - 単一銘柄あたり **1秒以内** で完了することを目標とする。
- 同時に複数銘柄を扱う際は、内部でバッチ化／並列化を検討する。

---

## 2. 信頼性・壊れ方

### NFR-TR-010 エラー発生時の振る舞い
- 予期せぬ例外・外部APIエラー発生時：
  - システムは **沈黙して誤ったシグナルを出してはならない**。
  - 原則として「エラー表示」または「前回の結果を無効とする」。

### NFR-TR-011 一貫性のある結果
- 同じデータ・同じ設定・同じ戦略ID/バージョンでバックテストを実行した場合、
  - 常に **同一の結果** が得られなければならない。
- 乱数等を使用するアルゴリズムでは、
  - シード値の固定もしくは結果のバラつき許容範囲を明示すること。

### NFR-TR-012 部分障害時の影響範囲
- 外部データソースが一部ダウンした場合：
  - 影響を受けた銘柄・期間をユーザーに示す。
  - システム全体を停止するのではなく、
    可能な範囲で結果を返す（ただし限定的であることを明示）。

---

## 3. ログ・監査・再現性

### NFR-TR-020 バックテスト再現性
- 各バックテスト実行には、一意な `run_id` を付与する。
- `run_id` に紐づく情報として、最低限以下を保存する：
  - 戦略ID・バージョン
  - パラメータセット
  - 銘柄・期間
  - 使用データソース・バージョン（可能ならハッシュ）
- 将来的には `run_id` を指定して「結果を再計算・比較」できる仕組みを目指す。

### NFR-TR-021 ログの内容
- ログには以下の情報を含める：
  - `timestamp`（UTC）
  - `level`（INFO/WARN/ERROR）
  - `run_id`（任意）
  - `strategy_id`
  - `symbol`
  - `message`（構造化されていることが望ましい）

### NFR-TR-022 監査ログ
- 将来的にユーザーアカウント機能を実装する場合、
  - バックテスト実行や設定変更は監査ログとして保存する。
  - 誰が・いつ・何をしたかを追跡可能にする。

---

## 4. セキュリティ・データ保護

### NFR-TR-030 現段階での個人情報
- 現段階では「ローカル環境での利用」を前提とし、
  個人情報（メールアドレス・パスワード等）は扱わない。
- 将来的にクラウドSaaS化する場合は、
  - `SECURITY_BASELINE_SAAS.md` に準拠すること。

### NFR-TR-031 外部APIキーの取り扱い
- 市場データプロバイダ等の APIキーは、
  - `.env` 等の環境変数経由で注入し、
  - Git リポジトリには一切含めてはならない。

### NFR-TR-032 ネットワーク公開範囲
- 検証段階のローカル実行では、
  - 原則として LAN 内のみからアクセス可能とする。
- 外部公開する際には、SaaS標準ドキュメントに定義された WAF/HTTPS 要件を満たすこと。

---

## 5. 可用性・保守性

### NFR-TR-040 開発と本番の分離
- 当面はローカル開発のみだが、将来的なクラウド化を見据え：
  - `dev`・`staging`・`prod` の 3 環境を論理的に分離する方針とする。
- 設定値は環境変数で切り替え可能とする。

### NFR-TR-041 モジュール構造
- バックテストエンジン・シグナルロジック・UI 等は、
  - それぞれ独立したモジュールとして実装し、差し替えやすくする。
- これは保守性・テスト性向上のための原則である。

---

## 6. テスト性

### NFR-TR-050 自動テストのカバレッジ
- 最低限、以下の領域には単体テストを用意する：
  - ポジションサイジング
  - 手数料・スリッページ計算
  - 代表的な戦略（MAクロス・RSI等）
- 回帰バグが発生した場合は、
  - 必ず再現テストを追加してから修正する。

### NFR-TR-051 テストデータセット
- 「検証用の固定データセット」を用意し、
  - テストが外部APIの状態に依存しないようにする。

---

以上。
