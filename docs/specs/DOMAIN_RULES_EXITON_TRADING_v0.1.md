# DOMAIN_RULES_EXITON_TRADING_v0.1.md
EXITON 自動投資システム — ドメインルール v0.1
==========================================

本ドキュメントは、EXITON 自動投資システム
（コード名：**ai-signal-chart / EXITON Trading Simulator**、以下「本システム」）における
**業務ルール・投資ロジック上の前提・安全装置** を定義する。

このルールは：

- バックエンド実装（特に `backend/core` / `backend/strategies`）
- テスト設計・レビュー
- 将来の商用化検討

において **必ず守られるべき制約条件** である。

ルールID形式：`DR-TR-XXX`。

---

## 1. システムの目的・スコープ

### DR-TR-001 システムの目的
- 本システムは、株式・ETF 等の市場データを用いて：
  - 売買戦略のバックテスト
  - パラメータ最適化
  - 売買シグナルの可視化
  を行う **学習・検証用ツール** である。
- 利用者に対して「どの戦略がどの程度機能したか」を可視化し、
  自らの投資判断をサポートすることを目的とする。

### DR-TR-002 自動発注は行わない
- 本システムは、**証券会社への自動発注機能を持たない**。
- 本システムが出力する内容はあくまで「シグナル・バックテスト結果」であり、
  実際の売買執行は利用者が自ら使用する証券会社ツール等で行う。

### DR-TR-003 対象ユーザー
- 個人投資家・個人開発者・開発者兼トレーダーを主な対象とする。
- 金融機関向けのシステムを直接代替することは想定していない。

### DR-TR-004 将来の商用化
- 将来的に SaaS として有料提供する可能性を考慮し、
  本ドキュメントのルールは **商用化前提の安全性・説明責任** を意識して設計する。

---

## 2. データに関するルール（時系列・OHLCV）

### DR-TR-010 ルックアヘッド禁止
- いかなるバックテスト・シミュレーションにおいても、
  **その時点で利用できなかった未来のデータを参照してはならない**。
- 特に以下は禁止：
  - 当日終値でシグナルを生成し、同じ終値で約定させる
  - 翌日のギャップ（ギャップアップ/ダウン）を当日の判断材料に使う
- 実装では「利用可能なインデックス範囲」を明示し、
  テストでルックアヘッドがないことを検証する。

### DR-TR-011 時刻・タイムゾーン
- 内部保存は原則として **UTC** を用いる。
- 表示の際はユーザー設定に応じたタイムゾーン（デフォルト：JST）で表示する。
- 日足データの1本のバーは、データプロバイダの定義に従い、
  その解釈（どの時間帯を含むか）を揃える。

### DR-TR-012 データ欠損・異常値
- 欠損・明らかなスパイク等が検出された場合：
  - デフォルト動作は「警告を出して当該期間のバックテストをスキップ」または「処理を中断」。
- 補間（前日値保持・線形補間等）を行う場合：
  - 採用した補間手法を明記し、バックテスト結果の解釈に影響することを示す。

---

## 3. 売買ロジック・リスク管理ルール

### DR-TR-020 売買単位
- 株式のバックテストにおいて、売買数量は常に **売買単位（単位株）** に丸める。
- デフォルト丸め規則：
  - `floor(計算上の株数)`（切り捨て）
- 丸め方法を変更する場合はドキュメントとテストで明示する。

### DR-TR-021 手数料・スリッページ
- バックテストでは、**必ず手数料またはスリッページモデルを適用する**。
- 少なくとも以下のいずれかをサポートする：
  - 固定額手数料（例：1トレードあたり¥100）
  - 約定代金に比例する手数料（例：0.1%）
  - スリッページ（例：約定価格に ±X% の誤差）
- UI で選択可能にする場合、結果への影響が分かる形で表示する。

### DR-TR-022 レバレッジ
- 本システムのデフォルト設定では **レバレッジ1倍（現物のみ）** を前提とする。
- 信用取引・レバレッジを導入する場合：
  - 証拠金管理・強制ロスカット等のルールを別途定義し、
  - 新しいドメインルール ID として追加する。

### DR-TR-023 Rベースのポジションサイジング
- ポジションサイズは原則として **1R（口座資金に対する許容損失量）概念**に基づいて計算する。
- ユーザーは：
  - 1R を金額（¥）または [%] で指定する。
  - ストップ位置に応じて株数が決まる。
- 詳細な式は `RISK_MANAGEMENT_SPEC.md` にて定義する。

---

## 4. 安全装置（Fail-safe / 金融安全）

### DR-TR-060 最大ポジションサイズ（Max Position Size）
- 本システムが計算・提案する1トレードのリスクは、
  **口座資金の `max_risk_per_trade` を超えてはならない**。
- デフォルト値の例：
  - `max_risk_per_trade = 0.02`（口座の2%）
- この制限は：
  - バックテスト
  - リアルタイムシグナル提案
  の双方に適用する。

### DR-TR-061 口座全体リスク（Max Portfolio Risk）
- 同時保有している全ポジションの合計リスクは、
  **口座資金の `max_portfolio_risk` を超えてはならない**。
- 例：`max_portfolio_risk = 0.10`（10%）

### DR-TR-062 キルスイッチ（Drawdown Kill Switch）
- 累積ドローダウン（ピークからの下落率）が `kill_switch_drawdown` を超えた場合：
  - すべてのポジションをクローズしたものとみなし、
  - 以後のバックテストシグナル生成を停止する。
- リアルタイム運用に拡張する場合も、同様のキルスイッチ発想を適用する。

### DR-TR-063 過大ポジションの禁止
- もし戦略ロジックが誤って異常なサイズ（例：口座の100%超）を返した場合：
  - システムは **強制的に取引をキャンセル** し、
  - ログに警告を記録する（silent failure 禁止）。

---

## 5. 戦略・シグナルの定義

### DR-TR-030 戦略IDとバージョン
- 各戦略には `STR_<カテゴリ>_<番号>` のIDを付与する：
  - 例：`STR_MA_001`, `STR_RSI_001`
- ロジックの構造変更時はバージョン番号を更新する：
  - 例：`STR_MA_001 v1.1`
- バックテスト結果および保存戦略プリセットには、
  - 戦略ID + バージョンを必ず紐づける。

### DR-TR-031 シグナルの意味の統一
- シグナルの標準定義：
  - `BUY`：ロングポジションを新規に建てる、またはショートをクローズしてロングに転換
  - `SELL`：ロングポジションをクローズする（現物のみの場合）
  - `HOLD`：新規アクションなし
- 戦略固有のシグナル（例：`REDUCE`, `ADD`) を追加する場合は、
  - `STRATEGY_DOC_<ID>.md` に意味と挙動を明記する。

### DR-TR-032 シグナル生成のタイミング
- 日足戦略の場合：
  - 当日終値確定後にシグナルを決定し、
  - 翌営業日寄り付きでの約定を前提とする。
- 足種・タイミングが異なる戦略では、
  - どのバーのどのタイミングのデータを使うかをドキュメントに明示する。

---

## 6. 利用者への説明・リスク表示

### DR-TR-040 投資助言ではない旨の明示
- 本システムは **投資一任・投資助言サービスではない**。
- UI 上に、目立つ形で以下を表示する：
  - 「本ツールは投資判断の参考情報を提供するものであり、
     実際の投資判断・売買は利用者自身の責任で行ってください。」

### DR-TR-041 過去成績と将来成績
- バックテスト結果を表示する画面には、
  「過去の運用成績は将来の成績を保証するものではありません。」
  の注意書きを常に添える。

---

## 7. 変更管理

### DR-TR-050 本ドキュメントの変更手順
- 本ドキュメントを変更する際は：
  1. GitHub Pull Request として変更案を提出
  2. 変更理由・影響範囲を `SPEC_HISTORY.md` に記録
  3. PM（こうすけ）または指定されたレビューAIの承認後にマージ

### DR-TR-051 バージョン管理
- 重大なルール変更（例：レバレッジ解禁、キルスイッチ無効化）は、
  - ドキュメントバージョンを `v0.1 → v0.2` のように更新する。
- 古いバージョンで実行したバックテスト結果は、
  - その時点のルールバージョンとともに保存・表示することが望ましい。

---

以上。
