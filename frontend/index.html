<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Signal Chart System</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 260px;
            padding: 16px;
            background: #161b22;
            border-right: 1px solid #30363d;
            box-sizing: border-box;
        }

        #sidebar h2 {
            margin-top: 0;
            font-size: 18px;
        }

        #sidebar label {
            display: block;
            margin: 10px 0 4px;
            font-size: 12px;
            text-transform: uppercase;
            color: #8b949e;
        }

        #sidebar input,
        #sidebar select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #30363d;
            background: #0d1117;
            color: #e6edf3;
        }

        #sidebar button {
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: #238636;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }

        #sidebar button:disabled {
            background: #30363d;
            cursor: not-allowed;
        }

        #ma-toggle-group {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #30363d;
        }

        #ma-toggle-group .toggle-row {
            display: flex;
            align-items: center;
            margin-top: 4px;
            font-size: 12px;
            color: #c9d1d9;
        }

        #ma-toggle-group .toggle-row input[type="checkbox"] {
            width: auto;
            margin-right: 6px;
        }

        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
            box-sizing: border-box;
        }

        #chart {
            flex: 1;
            min-height: 380px;
        }

        #trades-panel {
            margin-top: 8px;
            max-height: 220px;
            overflow-y: auto;
            border-top: 1px solid #30363d;
            padding-top: 6px;
        }

        #trades-panel h3 {
            margin: 0 0 4px;
            font-size: 14px;
        }

        #trades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        #trades-table th,
        #trades-table td {
            padding: 2px 4px;
            text-align: right;
            border-bottom: 1px solid #21262d;
            white-space: nowrap;
        }

        #trades-table th {
            text-align: right;
            font-weight: normal;
            color: #8b949e;
            position: sticky;
            top: 0;
            background: #0d1117;
        }

        #trades-table td.side-long {
            color: #2ea043;
        }

        #trades-table td.side-short {
            color: #f0883e;
        }

        #trades-table td.pnl-positive {
            color: #2ea043;
        }

        #trades-table td.pnl-negative {
            color: #f85149;
        }

        #status {
            margin-top: 4px;
            font-size: 12px;
            color: #8b949e;
        }


        #trades-table td.side-long {
            color: #2ea043;
        }

        #trades-table td.side-short {
            color: #f0883e;
        }

        #trades-table td.pnl-positive {
            color: #2ea043;
        }

        #trades-table td.pnl-negative {
            color: #f85149;
        }

        #trades-table tbody tr:hover {
            background: #1c2128;
            cursor: pointer;
        }

        #trades-table tr.selected {
            background: #21262d;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <h2>Signal Settings</h2>
        <label for="symbol">Symbol</label>
        <input id="symbol" type="text" value="BTC/USDT" />

        <label for="timeframe">Timeframe</label>
        <select id="timeframe">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>

        <label for="limit">Limit (50-1000)</label>
        <input id="limit" type="number" value="200" min="50" max="1000" />

        <label for="short_window">Short MA</label>
        <input id="short_window" type="number" value="9" min="1" max="500" />

        <label for="long_window">Long MA</label>
        <input id="long_window" type="number" value="21" min="1" max="500" />

        <!-- MA 表示/非表示トグル -->
        <div id="ma-toggle-group">
            <div class="toggle-row">
                <input id="show_short_ma" type="checkbox" checked />
                <span>Show Short MA</span>
            </div>
            <div class="toggle-row">
                <input id="show_long_ma" type="checkbox" checked />
                <span>Show Long MA</span>
            </div>
        </div>

        <label for="tp_ratio">Take Profit Ratio</label>
        <input id="tp_ratio" type="number" value="0.01" min="0" step="0.001" />

        <label for="sl_ratio">Stop Loss Ratio</label>
        <input id="sl_ratio" type="number" value="0.005" min="0" step="0.001" />

        <button id="updateButton">Update</button>
    </div>

    <div id="content">
        <div id="chart"></div>

        <div id="trades-panel">
            <h3>Trades (latest 20)</h3>
            <table id="trades-table">
                <thead>
                    <tr>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Side</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>PnL %</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JSで埋める -->
                </tbody>
            </table>
        </div>

        <div id="status">Waiting for data...</div>
    </div>

    <script>

        function focusOnTrade(entryTime, exitTime) {
            // エントリー〜イグジットの前後にちょっと余白をつける（秒）
            const margin = 5 * 60; // 5分分の余白（timeframeによって好みで調整）

            const from = entryTime - margin;
            const to = exitTime + margin;

            chart.timeScale().setVisibleRange({ from, to });
        }

        const chartContainer = document.getElementById("chart");
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: { background: { color: "#0d1117" }, textColor: "#e6edf3" },
            grid: {
                vertLines: { color: "#161b22" },
                horzLines: { color: "#161b22" },
            },
            timeScale: { timeVisible: true, secondsVisible: true },
            rightPriceScale: { borderColor: "#30363d" },
            localization: { dateFormat: "yyyy-MM-dd" },
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: "#26a69a",
            downColor: "#ef5350",
            borderUpColor: "#26a69a",
            borderDownColor: "#ef5350",
            wickUpColor: "#26a69a",
            wickDownColor: "#ef5350",
        });

        // MA用ラインシリーズ
        const shortMaSeries = chart.addLineSeries({
            color: "#f1c40f", // 黄色: 短期
            lineWidth: 2,
        });

        const longMaSeries = chart.addLineSeries({
            color: "#3498db", // 青: 長期
            lineWidth: 2,
        });

        let tpLine = null;
        let slLine = null;

        const statusEl = document.getElementById("status");
        const updateButton = document.getElementById("updateButton");

        const showShortMaCheckbox = document.getElementById("show_short_ma");
        const showLongMaCheckbox = document.getElementById("show_long_ma");

        const tradesTableBody = document.querySelector("#trades-table tbody");

        function buildQuery() {
            const params = new URLSearchParams({
                symbol: document.getElementById("symbol").value,
                timeframe: document.getElementById("timeframe").value,
                limit: document.getElementById("limit").value,
                short_window: document.getElementById("short_window").value,
                long_window: document.getElementById("long_window").value,
                tp_ratio: document.getElementById("tp_ratio").value,
                sl_ratio: document.getElementById("sl_ratio").value,
            });
            return `/api/chart-data?${params.toString()}`;
        }

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.style.color = isError ? "#f85149" : "#8b949e";
        }

        function renderChart(data) {
            const candles = data.candles.map((candle) => ({
                time: candle.time,
                open: candle.open,
                high: candle.high,
                low: candle.low,
                close: candle.close,
            }));
            candleSeries.setData(candles);

            // MA線のデータ更新
            const shortMaData = data.short_ma.map((p) => ({
                time: p.time,
                value: p.value,
            }));
            const longMaData = data.long_ma.map((p) => ({
                time: p.time,
                value: p.value,
            }));
            shortMaSeries.setData(shortMaData);
            longMaSeries.setData(longMaData);

            // 表示/非表示の状態を反映
            shortMaSeries.applyOptions({ visible: showShortMaCheckbox.checked });
            longMaSeries.applyOptions({ visible: showLongMaCheckbox.checked });

            const markers = data.signals.map((signal) => ({
                time: signal.time,
                position: signal.side === "BUY" ? "belowBar" : "aboveBar",
                color: signal.side === "BUY" ? "#2ea043" : "#f0883e",
                shape: signal.side === "BUY" ? "arrowUp" : "arrowDown",
                text: `${signal.side}`,
            }));
            candleSeries.setMarkers(markers);

            if (tpLine) candleSeries.removePriceLine(tpLine);
            if (slLine) candleSeries.removePriceLine(slLine);

            if (data.signals.length > 0) {
                const last = data.signals[data.signals.length - 1];
                tpLine = candleSeries.createPriceLine({
                    price: last.take_profit,
                    color: "#2ea043",
                    lineWidth: 1,
                    lineStyle: 0,
                    axisLabelVisible: true,
                    title: `${last.side} TP`,
                });
                slLine = candleSeries.createPriceLine({
                    price: last.stop_loss,
                    color: "#f85149",
                    lineWidth: 1,
                    lineStyle: 0,
                    axisLabelVisible: true,
                    title: `${last.side} SL`,
                });
            }
        }

        function formatTime(sec) {
            const d = new Date(sec * 1000);
            return d.toLocaleTimeString("ja-JP", {
                hour12: false,
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
            });
        }

        function renderTrades(trades) {
            tradesTableBody.innerHTML = "";

            if (!trades || trades.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 6;
                cell.textContent = "No closed trades in this window.";
                cell.style.textAlign = "left";
                tradesTableBody.appendChild(row);
                row.appendChild(cell);
                return;
            }

            const recent = trades.slice(-20); // 最新20件だけ表示

            for (const t of recent) {
                const row = document.createElement("tr");

                // 行にエントリー/イグジットの時刻を持たせておく
                row.dataset.entryTime = String(t.entry_time);
                row.dataset.exitTime = String(t.exit_time);

                const tdEntryTime = document.createElement("td");
                tdEntryTime.textContent = formatTime(t.entry_time);
                row.appendChild(tdEntryTime);

                const tdExitTime = document.createElement("td");
                tdExitTime.textContent = formatTime(t.exit_time);
                row.appendChild(tdExitTime);

                const tdSide = document.createElement("td");
                tdSide.textContent = t.side;
                tdSide.classList.add(
                    t.side === "LONG" ? "side-long" : "side-short"
                );
                row.appendChild(tdSide);

                const tdEntryPrice = document.createElement("td");
                tdEntryPrice.textContent = t.entry_price.toFixed(2);
                row.appendChild(tdEntryPrice);

                const tdExitPrice = document.createElement("td");
                tdExitPrice.textContent = t.exit_price.toFixed(2);
                row.appendChild(tdExitPrice);

                const tdPnl = document.createElement("td");
                const pnlPct = t.pnl * 100;
                const sign = pnlPct >= 0 ? "+" : "";
                tdPnl.textContent = `${sign}${pnlPct.toFixed(2)}`;
                tdPnl.classList.add(
                    pnlPct > 0 ? "pnl-positive" : pnlPct < 0 ? "pnl-negative" : ""
                );
                row.appendChild(tdPnl);

                // ★ ここがクリック時の処理
                row.addEventListener("click", () => {
                    // まず既存の選択を外す
                    for (const r of tradesTableBody.querySelectorAll("tr.selected")) {
                        r.classList.remove("selected");
                    }
                    row.classList.add("selected");

                    const entryTime = Number(row.dataset.entryTime);
                    const exitTime = Number(row.dataset.exitTime);
                    focusOnTrade(entryTime, exitTime);
                });

                tradesTableBody.appendChild(row);
            }
        }


        async function fetchData() {
            updateButton.disabled = true;
            setStatus("Fetching data...");
            try {
                const response = await fetch(buildQuery());
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "API error");
                }
                const data = await response.json();
                renderChart(data);
                renderTrades(data.trades || []);

                // PnL サマリ表示
                let summaryText = "";
                if (data.summary && data.summary.total_trades > 0) {
                    const winRatePct = (data.summary.win_rate * 100).toFixed(1);
                    const pnlPct = (data.summary.total_pnl * 100).toFixed(2);
                    const sign = data.summary.total_pnl >= 0 ? "+" : "";
                    summaryText =
                        ` | Trades: ${data.summary.total_trades}` +
                        `, Win rate: ${winRatePct}%` +
                        `, PnL: ${sign}${pnlPct}%`;
                }

                setStatus(
                    `Loaded ${data.candles.length} candles, ${data.signals.length} signals${summaryText}`
                );
            } catch (error) {
                console.error(error);
                setStatus(error.message || "Failed to load data", true);
            } finally {
                updateButton.disabled = false;
            }
        }

        updateButton.addEventListener("click", () => {
            fetchData();
        });

        // MA表示チェックボックスのイベント
        showShortMaCheckbox.addEventListener("change", (e) => {
            shortMaSeries.applyOptions({ visible: e.target.checked });
        });

        showLongMaCheckbox.addEventListener("change", (e) => {
            longMaSeries.applyOptions({ visible: e.target.checked });
        });

        // Initial load
        fetchData();

        // 5秒ごとに自動更新
        setInterval(() => {
            fetchData();
        }, 5000);

        window.addEventListener("resize", () => {
            const { width, height } = chartContainer.getBoundingClientRect();
            chart.applyOptions({ width, height });
        });
    </script>
</body>

</html>